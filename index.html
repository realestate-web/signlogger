// Code.gs (Apps Script)
const SHEET_ID   = '1o7ZEB33XaqbaJLwZB8KFZ0x28Mm0j5JjXNtkbIZymX8';
const SHEET_NAME = 'Master';

function doGet(e) {
  const cb = e.parameter.callback;
  // JSONP fetch
  if (e.parameter.action==='fetch' && e.parameter.sign && cb) {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sh = ss.getSheetByName(SHEET_NAME);
    const ids = sh.getRange(2,1,sh.getLastRow()-1).getValues().flat();
    const idx = ids.indexOf(e.parameter.sign);
    let payload = {};
    if (idx>=0) {
      const row = idx+2;
      const t = sh.getRange(row,4).getValue();
      payload = {
        sign:      e.parameter.sign,
        timestamp: t instanceof Date
          ? Utilities.formatDate(t, Session.getScriptTimeZone(),"dd MMM yyyy HH:mm")
          : '',
        lat:       sh.getRange(row,5).getValue(),
        lng:       sh.getRange(row,6).getValue(),
        address:   sh.getRange(row,7).getValue(),
        installer: sh.getRange(row,8).getValue(),
        notes:     sh.getRange(row,9).getValue(),
        type:      sh.getRange(row,10).getValue(),
        condition: sh.getRange(row,11).getValue(),
        signType:  sh.getRange(row,12).getValue()
      };
    }
    return ContentService
      .createTextOutput(`${cb}(${JSON.stringify(payload)})`)
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  // JSONP log
  if (e.parameter.sign && e.parameter.lat && e.parameter.callback) {
    const data = {
      sign:      e.parameter.sign,
      lat:       e.parameter.lat,
      lng:       e.parameter.lng||'',
      address:   e.parameter.address||'',
      installer: e.parameter.installer||'',
      notes:     e.parameter.notes||'',
      type:      e.parameter.type||'',
      condition: e.parameter.condition||'',
      signType:  e.parameter.signType||''
    };
    logScan(data);
    return ContentService
      .createTextOutput(`${e.parameter.callback}(${JSON.stringify({status:'ok'})})`)
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  return ContentService.createTextOutput('');
}

function logScan(data) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sh = ss.getSheetByName(SHEET_NAME);
  const ids = sh.getRange(2,1,sh.getLastRow()-1).getValues().flat();
  const idx = ids.indexOf(data.sign);
  if (idx<0) return;
  const row = idx+2;
  sh.getRange(row,4).setValue(new Date());
  sh.getRange(row,5).setValue(data.lat);
  sh.getRange(row,6).setValue(data.lng);
  sh.getRange(row,7).setValue(data.address);
  sh.getRange(row,8).setValue(data.installer);
  sh.getRange(row,9).setValue(data.notes);
  sh.getRange(row,10).setValue(data.type);
  sh.getRange(row,11).setValue(data.condition);
  sh.getRange(row,12).setValue(data.signType);
}
