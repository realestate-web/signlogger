<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RE/MAX: Sign and Delivery</title>
  <link rel="icon" href="https://raw.githubusercontent.com/realestate-web/signlogger/main/favicon-light.png"
        media="(prefers-color-scheme: light)">
  <link rel="icon" href="https://raw.githubusercontent.com/realestate-web/signlogger/main/favicon-dark.png"
        media="(prefers-color-scheme: dark)">
  <style>
    :root { --remax-blue:#003da5; --charcoal:#333; --bg:#f5f5f5; --white:#fff }
    body { margin:0; font-family:sans-serif; background:var(--bg); color:var(--charcoal) }
    header { background:var(--white); text-align:center; padding:1em 0 }
    img.logo { max-width:200px }
    main { background:var(--remax-blue); color:var(--white); padding:1em; padding-bottom:3em }
    #info-box {
      position:relative; background:rgba(255,255,255,0.1);
      border:2px solid var(--charcoal); padding:1em;
      margin:0 auto 1em; border-radius:4px; max-width:500px; text-align:left
    }
    #info-box h1 { margin:0 0 .5em; font-size:1.5em; text-align:center; letter-spacing:1px }
    #info-box h3,#info-box p,#info-box h4 { margin:.3em 0 }
    #message {
      position:absolute; top:0; left:0; right:0;
      background:#4caf50; color:#fff; padding:.5em;
      text-align:center; font-weight:bold; display:none; border-radius:2px 2px 0 0
    }
    #map img, #photo {
      width:100%; height:auto; border-radius:4px; margin:.5em 0; display:block
    }
    #photo { display:none; border:1px dashed var(--charcoal) }
    select,textarea {
      width:70%; max-width:350px; margin:.5em auto; display:block;
      padding:.5em; border:2px solid var(--charcoal); border-radius:4px;
      font-size:1em; color:var(--charcoal)
    }
    textarea { width:65%; max-width:325px; height:80px }
    button {
      background:var(--white); color:var(--charcoal);
      border:2px solid var(--charcoal); padding:.7em 1.5em;
      font-size:1.1em; border-radius:4px; cursor:pointer;
      margin:1em auto; display:block
    }
    button:hover { background:var(--charcoal); color:var(--white) }
  </style>
</head>
<body>
  <header>
    <img class="logo"
         src="https://remax-caymanislands-mikeb.com/wp-content/uploads/2019/04/remax_logo.png"
         alt="RE/MAX Logo">
  </header>
  <main>
    <div id="info-box">
      <div id="message">✅ Logged!</div>
      <h1>SIGN AND DELIVERY</h1>
      <h3>Sign ID: <span id="sign">…</span></h3>
      <p>Sign Size: <strong id="signSize">…</strong></p>
      <p>Type:      <strong id="lastType">–</strong></p>
      <h4>Last Installation</h4>
      <p>By:        <strong id="lastBy">–</strong></p>
      <p>On:        <strong id="lastWhen">–</strong></p>
      <p>At:        <strong id="lastLocation">–</strong></p>
      <p>Condition: <strong id="lastCondition">–</strong></p>
      <div id="map"></div>
      <img id="photo" alt="Sign photo">
    </div>

    <select id="installer">
      <option value="">Installer (none)</option>
      <option>JG</option><option>JB</option>
      <option>CL</option><option>WC</option>
    </select>

    <select id="condition">
      <option value="">Condition (none)</option>
      <option>OK</option><option>Fair</option>
      <option>Poor</option><option>Replace</option>
    </select>

    <textarea id="notes" placeholder="Notes (optional)…"></textarea>
    <button id="recordBtn">Record Installation</button>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const MAPS_KEY = 'AIzaSyDYOE-sqSuFAIZgMhlJtNQLdBG0jcDHILQ';
      const SCRIPT   = 'https://script.google.com/macros/s/AKfycbzExAYZaUDnLgCkG2gHYTMbfo5--jHCmhl7rTrxawQmuKsle54Pyt6dTmOnVhJ3xUaqIA/exec';
      const ps       = new URLSearchParams(location.search);
      const sign     = ps.get('sign')     || 'UNKNOWN';
      const signType = ps.get('signType') || '';

      // initial
      document.getElementById('sign').textContent     = sign;
      document.getElementById('signSize').textContent = signType;

      // JSONP callback
      window.renderSummary = data => {
        if (!data.timestamp) return;
        document.getElementById('lastBy').textContent        = data.installer;
        document.getElementById('lastWhen').textContent      = data.timestamp;
        document.getElementById('lastLocation').textContent  = data.address;
        document.getElementById('lastCondition').textContent = data.condition;
        document.getElementById('lastType').textContent      = data.type;
        if (data.signType) document.getElementById('signSize').textContent = data.signType;
        if (data.lat && data.lng) {
          document.getElementById('map').innerHTML =
            `<img src="https://maps.googleapis.com/maps/api/staticmap?center=${data.lat},${data.lng}`
            + `&zoom=17&size=300x150&markers=color:red|${data.lat},${data.lng}`
            + `&key=${MAPS_KEY}">`;
        }
      };

      // initial fetch
      const fetcher = document.createElement('script');
      fetcher.src = `${SCRIPT}?action=fetch&sign=${encodeURIComponent(sign)}&callback=renderSummary`;
      document.body.appendChild(fetcher);

      // record
      document.getElementById('recordBtn').onclick = () => {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude, lng = pos.coords.longitude;
          fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${MAPS_KEY}`)
            .then(r=>r.json()).then(js => {
              const addr = js.results[0]?.formatted_address||'';
              const cb   = '__logged__';
              window[cb] = resp => {
                if (resp.status==='ok') {
                  document.getElementById('message').style.display='block';
                  setTimeout(()=>document.getElementById('message').style.display='none',2000);
                  // re-fetch
                  const r2 = document.createElement('script');
                  r2.src = `${SCRIPT}?action=fetch&sign=${encodeURIComponent(sign)}&callback=renderSummary`;
                  document.body.appendChild(r2);
                }
                delete window[cb];
              };
              const parts = [
                `sign=${encodeURIComponent(sign)}`,
                `signType=${encodeURIComponent(signType)}`,
                `lat=${lat}`, `lng=${lng}`,
                `address=${encodeURIComponent(addr)}`,
                `installer=${encodeURIComponent(document.getElementById('installer').value)}`,
                `notes=${encodeURIComponent(document.getElementById('notes').value)}`,
                `type=${encodeURIComponent(ps.get('type')||'')}`,
                `condition=${encodeURIComponent(document.getElementById('condition').value)}`,
                `callback=${cb}`
              ].join('&');
              const logger = document.createElement('script');
              logger.src = `${SCRIPT}?${parts}`;
              document.body.appendChild(logger);
            });
        }, err => alert('Location error: '+err.message));
      };
    });
  </script>
</body>
</html>
