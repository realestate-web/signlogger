<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RE/MAX: Sign and Delivery</title>
  <link rel="icon" href="https://raw.githubusercontent.com/realestate-web/signlogger/main/favicon-light.png"
        media="(prefers-color-scheme: light)">
  <link rel="icon" href="https://raw.githubusercontent.com/realestate-web/signlogger/main/favicon-dark.png"
        media="(prefers-color-scheme: dark)">
  <style>
    /* (your CSS from before) */
  </style>
</head>
<body>
  <header>
    <img class="logo"
         src="https://remax-caymanislands-mikeb.com/wp-content/uploads/2019/04/remax_logo.png"
         alt="RE/MAX Logo">
  </header>

  <main>
    <div id="info-box">
      <div id="message">✅ Logged!</div>
      <h1>SIGN AND DELIVERY</h1>
      <h3>Sign ID: <span id="sign">…</span></h3>
      <p>Sign Size: <strong id="signSize">…</strong></p>
      <p>Type:      <strong id="lastType">–</strong></p>
      <h4>Last Installation</h4>
      <p>By:        <strong id="lastBy">–</strong></p>
      <p>On:        <strong id="lastWhen">–</strong></p>
      <p>At:        <strong id="lastLocation">–</strong></p>
      <p>Condition: <strong id="lastCondition">–</strong></p>
      <div id="map"></div>
      <img id="photo" alt="Sign photo">
    </div>

    <select id="installer">…</select>
    <select id="condition">…</select>
    <textarea id="notes" placeholder="Notes (optional)…"></textarea>
    <button id="recordBtn">Record Installation</button>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const MAPS_KEY  = 'AIzaSyDYOE-sqSuFAIZgMhlJtNQLdBG0jcDHILQ';
    const SCRIPT    = 'https://script.google.com/macros/s/AKfycbzExAYZaUDnLgCkG2gHYTMbfo5--jHCmhl7rTrxawQmuKsle54Pyt6dTmOnVhJ3xUaqIA/exec';
    const params    = new URLSearchParams(location.search);
    const sign      = params.get('sign')     || 'UNKNOWN';
    const signType  = params.get('signType') || '';
    document.getElementById('sign').textContent     = sign;
    document.getElementById('signSize').textContent = signType;

    // JSONP callback
    window.renderSummary = data => {
      if (!data.timestamp) return;
      document.getElementById('lastBy').textContent        = data.installer;
      document.getElementById('lastWhen').textContent      = data.timestamp;
      document.getElementById('lastLocation').textContent  = data.address;
      document.getElementById('lastCondition').textContent = data.condition;
      document.getElementById('lastType').textContent      = data.type;
      if (data.signType) document.getElementById('signSize').textContent = data.signType;
      if (data.lat && data.lng) {
        document.getElementById('map').innerHTML =
          `<img src="https://maps.googleapis.com/maps/api/staticmap`
          + `?center=${data.lat},${data.lng}`
          + `&zoom=17&size=300x150`
          + `&markers=color:red|${data.lat},${data.lng}`
          + `&key=${MAPS_KEY}">`;
      }
    };

    // initial fetch
    const loader = document.createElement('script');
    loader.src = `${SCRIPT}?action=fetch&sign=${encodeURIComponent(sign)}&callback=renderSummary`;
    document.body.appendChild(loader);

    // record-install
    document.getElementById('recordBtn').onclick = () => {
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${MAPS_KEY}`)
          .then(r => r.json())
          .then(js => {
            const addr = js.results[0]?.formatted_address||'';
            const cb = '__logged__';
            window[cb] = resp => {
              if (resp.status==='ok') {
                document.getElementById('message').style.display='block';
                setTimeout(()=>document.getElementById('message').style.display='none',2000);
                const refetch = document.createElement('script');
                refetch.src = `${SCRIPT}?action=fetch&sign=${encodeURIComponent(sign)}&callback=renderSummary`;
                document.body.appendChild(refetch);
              }
              delete window[cb];
            };
            const parts = [
              `sign=${encodeURIComponent(sign)}`,
              `signType=${encodeURIComponent(signType)}`,
              `lat=${lat}`, `lng=${lng}`,
              `address=${encodeURIComponent(addr)}`,
              `installer=${encodeURIComponent(document.getElementById('installer').value)}`,
              `notes=${encodeURIComponent(document.getElementById('notes').value)}`,
              `type=${encodeURIComponent(params.get('type')||'')}`,
              `condition=${encodeURIComponent(document.getElementById('condition').value)}`,
              `callback=${cb}`
            ].join('&');
            const logScript = document.createElement('script');
            logScript.src = `${SCRIPT}?${parts}`;
            document.body.appendChild(logScript);
          });
      }, err => alert('Location error: '+err.message));
    };
  });
  </script>
</body>
</html>
